#!/bin/sh

# Add Node.js repository
chroot $1 curl -fsSL https://deb.nodesource.com/setup_20.x | bash -

# Install required packages
chroot $1 apt install -y nodejs tailscale cage chromium

# Set up SSH key
mkdir -p $1/root/.ssh
chmod 700 $1/root/.ssh
echo "${IGconf_ssh_public_key}" > $1/root/.ssh/authorized_keys
chmod 600 $1/root/.ssh/authorized_keys

# Install hall-sensor-server dependencies
chroot $1 bash -c 'cd /opt/hall-sensor-server && npm install'

# Enable overlayfs
echo "overlay" >> $1/etc/modules
echo "overlay" > $1/etc/modules-load.d/overlay.conf

# Make boot script executable
chmod +x $1/usr/local/bin/boot_packet_run.sh

# Enable services
$BDEBSTRAP_HOOKS/enable-units "$1" hall-sensor-server tailscale kiosk

# Create packet_run_config.txt from template
cat ../packet_run_config.txt.tpl | sed \
   -e "s|<PACKET_RUN_TERMINAL_ID>|${IGconf_packet_run_terminal_id}|g" \
   -e "s|<PACKET_RUN_SERVER_IP>|${IGconf_packet_run_server_ip}|g" \
   -e "s|<TAILSCALE_AUTH_KEY>|${IGconf_tailscale_auth_key}|g" \
   -e "s|<TAILSCALE_LOGIN_SERVER>|${IGconf_tailscale_login_server:-https://login.tailscale.com}|g" \
   > $1/boot/packet_run_config.txt